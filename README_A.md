# README A: ACT-style 双编码器 + 扩散解码（Hierarchical Intent via Demonstration）

## 1. 目标与动机

本实现验证一种 **受 ACT 启发的双编码器串联架构**，用于在视觉导航中学习层次化意图，并通过潜变量优化生成对抗性轨迹。

核心思想是：

* 使用参考轨迹（demonstration / planner output）学习**高层策略意图**；
* 将高层意图与当前观测结合，生成**可执行的低层意图**；
* 使用 diffusion policy 在低层意图条件下生成轨迹。

该方案重点验证：

> 是否可以通过优化高层潜变量，在不直接操作 action 的情况下，系统性地产生多样化（含对抗性）的轨迹行为。

---

## 2. 方法概述

### 2.1 架构组成

* **High-level Encoder `E_high`**
  输入：历史观测 `o_{0:T}` + 参考轨迹 `τ_ref`
  输出：高层潜在意图 `z₁`

* **Low-level Encoder `E_low`**
  输入：当前观测 `o_t` + `z₁`
  输出：可执行潜变量 `z₂`

* **Diffusion Trajectory Decoder `D_diff`**
  条件：`z₂`（以及必要的视觉特征）
  输出：未来轨迹 `τ`

整体流程：

```
(o_{0:T}, τ_ref) → E_high → z₁
(o_t, z₁)       → E_low  → z₂
(z₂, o_t)       → D_diff → τ
```

---

## 3. 训练逻辑

### 3.1 训练阶段

* 使用包含参考轨迹的数据集（专家演示 / 规划器输出）
* 端到端训练 `E_high + E_low + D_diff`
* 目标：最大化轨迹似然 / diffusion 去噪损失

可选增强：

* 对 `τ_ref` 做 dropout（reference-free 训练）以缓解推理时分布偏移
* 对 `z₁` 加正则或 KL 约束，限制潜空间

### 3.2 损失函数

* Diffusion 去噪损失（主）
* `z₁` 正则项（可选）
* `z₂` 稳定性或信息约束（可选）

---

## 4. 推理与对抗生成

### 4.1 推理阶段改动

* **移除参考轨迹编码器输入**
* 将 `z₁` 视为可优化变量（或从先验采样）

### 4.2 对抗性轨迹生成

* 固定当前观测 `o_t`
* 通过梯度或采样方式优化 `z₁`
* 目标函数示例：

  * 诱发他人避让
  * 减小他人安全裕度
  * 增加交互不确定性

---

## 5. Demo 实验建议

### 可行性验证（Stage 1）

* 固定 `z₁`，观察轨迹多样性
* 随机扰动 `z₁`，检查轨迹是否仍可执行

### 性能验证（Stage 2）

* 对比：

  * 原始 `z₁`
  * 优化后 `z₁`
* 指标：成功率、碰撞率、交互强度

---

## 6. 适用与局限

**适用场景**：

* 有高质量参考轨迹
* 希望学习整体策略风格

**主要局限**：

* 对抗意图是隐式的
* 推理时 `z₁` 优化存在分布偏移风险

---

